import { create } from 'zustand'

export type Language = 'pt-BR' | 'en' | 'es' | 'ar' | 'ru'

type Params = Record<string, string | number>

const STORAGE_KEY = 'gamium_language'

function detectSystemLanguage(): Language {
  const lang = (navigator.language || 'pt-BR').toLowerCase()
  if (lang.startsWith('pt')) return 'pt-BR'
  if (lang.startsWith('en')) return 'en'
  if (lang.startsWith('es')) return 'es'
  if (lang.startsWith('ar')) return 'ar'
  if (lang.startsWith('ru')) return 'ru'
  return 'pt-BR'
}

function getInitialLanguage(): Language {
  const saved = localStorage.getItem(STORAGE_KEY) as Language | null
  if (saved && ['pt-BR', 'en', 'es', 'ar', 'ru'].includes(saved)) return saved
  return detectSystemLanguage()
}

const translations: Record<Language, Record<string, string>> = {
  'pt-BR': {
    'title.updateReady': 'Atualização pronta',
    'title.updateAvailable': 'Atualização disponível',
    'title.downloadNow': 'Baixar agora',
    'title.downloadUpdate': 'Baixar atualização',
    'title.downloading': 'Baixando atualização...',
    'title.downloadedRestarting': 'Atualização baixada. Reiniciando...',
    'title.version': 'Versão: v{{version}}',
    'title.latestVersion': 'Você já está na versão mais recente.',

    'login.subtitle': 'Comunicação descentralizada e criptografada',
    'login.username': 'Nome de usuário',
    'login.usernameRequired': 'Nome de usuário é obrigatório.',
    'login.password': 'Senha',
    'login.minChars': 'mínimo 16 caracteres',
    'login.passwordRequired': 'A senha deve ter pelo menos 16 caracteres.',
    'login.connecting': 'Conectando...',
    'login.createAccount': 'Criar conta',
    'login.signIn': 'Entrar',
    'login.back': 'Voltar',
    'login.haveAccount': 'Já tem conta? Entrar',
    'login.noAccount': 'Não tem conta? Criar',
    'login.restore': 'Restaurar com Recovery Phrase',
    'login.viewLocalRecovery': 'Ver recovery phrase deste dispositivo',
    'login.backToLogin': 'Voltar para login',
    'login.recoveryRequired': 'Frase de recuperação é obrigatória.',
    'login.recovery': 'Frase de recuperação (12 palavras)',
    'login.recoveryHint': 'Cole suas 12 palavras separadas por espaço',
    'login.restoreAccount': 'Restaurar conta',
    'login.accountCreatedLoginNow': 'Conta criada. Agora faça login para continuar.',
    'login.deviceRecoveryNotFound': 'Nenhuma recovery phrase foi encontrada neste dispositivo.',
    'login.errorUnknown': 'Erro desconhecido.',
    'login.connectionError': 'Erro de conexão.',
    'login.e2e': 'Criptografia ponta a ponta',
    'login.p2p': 'Rede descentralizada P2P',
    'login.identity': 'Sua chave = sua identidade',
    'login.recoveryTitle': 'Sua frase de recuperação',
    'login.recoverySafe': 'Guarde em um lugar seguro!',
    'login.recoveryImportant': 'IMPORTANTE:',
    'login.recoveryStep1': 'Escreva ou copie estas 12 palavras',
    'login.recoveryStep2': 'Guarde em um lugar seguro (papel, cofre, etc.)',
    'login.recoveryStep3': 'Nunca compartilhe com ninguém',
    'login.recoveryStep4': 'Use para recuperar sua conta em outro dispositivo',
    'login.copyWords': 'Copiar palavras',
    'login.copied': 'Copiado!',
    'login.confirmSaved': 'Confirmo que guardei minha frase em local seguro',
    'login.continueLogin': 'Continuar para login',
    'login.continueApp': 'Continuar para Gamium',

    'nav.home': 'Início',
    'nav.createJoinServer': 'Criar/entrar no servidor',
    'user.onlineP2p': 'Online • P2P',
    'user.changeAvatar': 'Alterar foto de perfil',
    'user.copyId': 'Copiar Gamium ID',
    'user.recoverKeys': 'Recuperar chaves',
    'user.logout': 'Sair',
    'user.recoveryCopied': 'Recovery phrase copiada para a área de transferência. Guarde em local seguro.',
    'user.imageTooLarge': 'Imagem muito grande. Máximo 512KB.',

    'friends.title': 'Amigos',
    'friends.all': 'Todos',
    'friends.pending': 'Pendentes',
    'friends.add': 'Adicionar',
    'friends.yourId': 'Seu Gamium ID:',
    'friends.clickCopy': 'Clique para copiar',
    'friends.total': 'Todos os amigos — {{count}}',
    'friends.empty': 'Nenhum amigo ainda. Adicione alguém compartilhando seu Gamium ID!',
    'friends.pendingTitle': 'Solicitações pendentes — {{count}}',
    'friends.pendingEmpty': 'Nenhuma solicitação pendente.',
    'friends.accept': 'Aceitar',
    'friends.addTitle': 'Adicionar amigo',
    'friends.addDesc': 'Cole o Gamium ID do amigo abaixo.',
    'friends.addPlaceholder': 'Cole o Gamium ID aqui...',
    'friends.sendRequest': 'Enviar solicitação',
    'friends.searching': 'Buscando...',
    'friends.msg': 'Mensagem',
    'friends.remove': 'Remover',
    'friends.errorPasteId': 'Cole o Gamium ID do amigo.',
    'friends.errorSelf': 'Você não pode adicionar a si mesmo.',
    'friends.errorNotFound': 'Usuário não encontrado na rede.',
    'friends.errorSend': 'Erro ao enviar solicitação.',
    'friends.requestSent': 'Solicitação enviada para {{alias}}!',

    'servers.title': 'Servidores',
    'servers.createNew': 'Criar novo servidor',
    'servers.serverName': 'Nome do servidor...',
    'servers.create': 'Criar',
    'servers.or': 'ou',
    'servers.joinServer': 'Entrar em um servidor',
    'servers.pasteServerId': 'Cole o ID do servidor abaixo.',
    'servers.serverId': 'ID do servidor...',
    'servers.join': 'Entrar',
    'servers.selectServer': 'Selecione um servidor na barra lateral.',
    'servers.changeServerAvatar': 'Alterar foto do servidor',
    'servers.copyServerId': 'Copiar ID do servidor',
    'servers.memberList': 'Lista de membros',
    'servers.textChannels': 'CANAIS DE TEXTO',
    'servers.voiceChannels': 'CANAIS DE VOZ',
    'servers.you': '(você)',
    'servers.channelName': 'Nome do canal...',
    'servers.text': 'Texto',
    'servers.voice': 'Voz',
    'servers.createChannel': 'Criar canal',
    'servers.encryptedServer': 'Servidor criptografado',
    'servers.welcomeChannel': 'Bem-vindo ao #{{channel}}',
    'servers.channelStart': 'Este é o início do canal. Todas as mensagens são criptografadas.',
    'servers.members': 'Membros — {{count}}',
    'servers.ban': 'Banir {{alias}}',
    'servers.sendMessage': 'Enviar mensagem em #{{channel}}...',
    'servers.confirmBan': 'Tem certeza que deseja banir {{alias}} do servidor?',

    'groups.title': 'Grupos',
    'groups.none': 'Nenhum grupo ainda.',
    'groups.createTitle': 'Criar novo grupo',
    'groups.groupName': 'Nome do grupo',
    'groups.groupPlaceholder': 'Nome do grupo...',
    'groups.selectMembers': 'Selecione os membros',
    'groups.addFriendsFirst': 'Adicione amigos primeiro para criar um grupo.',
    'groups.create': 'Criar grupo',
    'groups.cancel': 'Cancelar',
    'groups.selectOrCreate': 'Selecione um grupo na barra lateral ou crie um novo.',
    'groups.encrypted': 'Grupo E2E • {{count}} membros',
    'groups.start': 'Início do grupo {{name}}',
    'groups.encryptedMessages': 'Todas as mensagens são criptografadas.',
    'groups.messageIn': 'Mensagem em {{name}}...',

    'chat.directMessage': 'Mensagem direta',
    'chat.encrypted': 'E2E criptografado',
    'chat.startConversation': 'Início da conversa com {{name}}',
    'chat.allEncrypted': 'Todas as mensagens são criptografadas ponta a ponta.',
    'chat.messageTo': 'Mensagem para {{name}}...',
    'chat.user': 'usuário',

    'voice.muted': 'Mudo',
    'voice.connected': 'Conectado à voz',
    'voice.waiting': 'Aguardando outros participantes...',
    'voice.me': '(você)',
    'voice.sharingYourScreen': 'Compartilhando sua tela',
    'voice.remoteScreen': 'Tela de {{name}}',
    'voice.unmute': 'Ativar microfone',
    'voice.mute': 'Silenciar',
    'voice.stopShare': 'Parar compartilhamento',
    'voice.share': 'Compartilhar tela',
    'voice.leave': 'Sair do canal de voz',

    'screen.title': 'Compartilhar tela',
    'screen.select': 'Selecione a tela ou janela que deseja compartilhar',
    'screen.loading': 'Buscando telas disponíveis...',
    'screen.none': 'Nenhuma tela ou janela encontrada.',
    'screen.cancel': 'Cancelar',
  },
  en: {
    'title.updateReady': 'Update ready',
    'title.updateAvailable': 'Update available',
    'title.downloadNow': 'Download now',
    'title.downloadUpdate': 'Download update',
    'title.downloading': 'Downloading update...',
    'title.downloadedRestarting': 'Update downloaded. Restarting...',
    'title.version': 'Version: v{{version}}',
    'title.latestVersion': 'You are already on the latest version.',
    'login.subtitle': 'Decentralized and encrypted communication',
    'login.username': 'Username',
    'login.usernameRequired': 'Username is required.',
    'login.password': 'Password',
    'login.minChars': 'minimum 16 characters',
    'login.passwordRequired': 'Password must be at least 16 characters.',
    'login.connecting': 'Connecting...',
    'login.createAccount': 'Create account',
    'login.signIn': 'Sign in',
    'login.back': 'Back',
    'login.haveAccount': 'Already have an account? Sign in',
    'login.noAccount': 'No account? Create one',
    'login.restore': 'Restore with recovery phrase',
    'login.viewLocalRecovery': 'View recovery phrase on this device',
    'login.backToLogin': 'Back to login',
    'login.recoveryRequired': 'Recovery phrase is required.',
    'login.recovery': 'Recovery phrase (12 words)',
    'login.recoveryHint': 'Paste your 12 words separated by spaces',
    'login.restoreAccount': 'Restore account',
    'login.accountCreatedLoginNow': 'Account created. Please sign in to continue.',
    'login.deviceRecoveryNotFound': 'No recovery phrase found on this device.',
    'login.errorUnknown': 'Unknown error.',
    'login.connectionError': 'Connection error.',
    'login.e2e': 'End-to-end encryption',
    'login.p2p': 'Decentralized P2P network',
    'login.identity': 'Your key = your identity',
    'login.recoveryTitle': 'Your recovery phrase',
    'login.recoverySafe': 'Store it in a safe place!',
    'login.recoveryImportant': 'IMPORTANT:',
    'login.recoveryStep1': 'Write down or copy these 12 words',
    'login.recoveryStep2': 'Keep them in a safe place',
    'login.recoveryStep3': 'Never share them',
    'login.recoveryStep4': 'Use them to recover your account',
    'login.copyWords': 'Copy words',
    'login.copied': 'Copied!',
    'login.confirmSaved': 'I confirm I saved my recovery phrase safely',
    'login.continueLogin': 'Continue to login',
    'login.continueApp': 'Continue to Gamium',
    'nav.home': 'Home',
    'nav.createJoinServer': 'Create/join server',
    'user.onlineP2p': 'Online • P2P',
    'user.changeAvatar': 'Change profile picture',
    'user.copyId': 'Copy Gamium ID',
    'user.recoverKeys': 'Recover keys',
    'user.logout': 'Log out',
    'user.recoveryCopied': 'Recovery phrase copied to clipboard.',
    'user.imageTooLarge': 'Image too large. Max 512KB.',
    'friends.title': 'Friends',
    'friends.all': 'All',
    'friends.pending': 'Pending',
    'friends.add': 'Add',
    'friends.yourId': 'Your Gamium ID:',
    'friends.clickCopy': 'Click to copy',
    'friends.total': 'All friends — {{count}}',
    'friends.empty': 'No friends yet.',
    'friends.pendingTitle': 'Pending requests — {{count}}',
    'friends.pendingEmpty': 'No pending requests.',
    'friends.accept': 'Accept',
    'friends.addTitle': 'Add friend',
    'friends.addDesc': 'Paste your friend\'s Gamium ID below.',
    'friends.addPlaceholder': 'Paste Gamium ID here...',
    'friends.sendRequest': 'Send request',
    'friends.searching': 'Searching...',
    'friends.msg': 'Message',
    'friends.remove': 'Remove',
    'friends.errorPasteId': 'Paste your friend\'s Gamium ID.',
    'friends.errorSelf': 'You cannot add yourself.',
    'friends.errorNotFound': 'User not found on network.',
    'friends.errorSend': 'Failed to send request.',
    'friends.requestSent': 'Request sent to {{alias}}!',
    'servers.title': 'Servers',
    'servers.createNew': 'Create new server',
    'servers.serverName': 'Server name...',
    'servers.create': 'Create',
    'servers.or': 'or',
    'servers.joinServer': 'Join a server',
    'servers.pasteServerId': 'Paste server ID below.',
    'servers.serverId': 'Server ID...',
    'servers.join': 'Join',
    'servers.selectServer': 'Select a server in the sidebar.',
    'servers.changeServerAvatar': 'Change server picture',
    'servers.copyServerId': 'Copy server ID',
    'servers.memberList': 'Member list',
    'servers.textChannels': 'TEXT CHANNELS',
    'servers.voiceChannels': 'VOICE CHANNELS',
    'servers.you': '(you)',
    'servers.channelName': 'Channel name...',
    'servers.text': 'Text',
    'servers.voice': 'Voice',
    'servers.createChannel': 'Create channel',
    'servers.encryptedServer': 'Encrypted server',
    'servers.welcomeChannel': 'Welcome to #{{channel}}',
    'servers.channelStart': 'This is the beginning of the channel. Messages are encrypted.',
    'servers.members': 'Members — {{count}}',
    'servers.ban': 'Ban {{alias}}',
    'servers.sendMessage': 'Send message in #{{channel}}...',
    'servers.confirmBan': 'Are you sure you want to ban {{alias}}?',
    'groups.title': 'Groups',
    'groups.none': 'No groups yet.',
    'groups.createTitle': 'Create new group',
    'groups.groupName': 'Group name',
    'groups.groupPlaceholder': 'Group name...',
    'groups.selectMembers': 'Select members',
    'groups.addFriendsFirst': 'Add friends first to create a group.',
    'groups.create': 'Create group',
    'groups.cancel': 'Cancel',
    'groups.selectOrCreate': 'Select a group or create a new one.',
    'groups.encrypted': 'E2E Group • {{count}} members',
    'groups.start': 'Start of group {{name}}',
    'groups.encryptedMessages': 'All messages are encrypted.',
    'groups.messageIn': 'Message in {{name}}...',
    'chat.directMessage': 'Direct message',
    'chat.encrypted': 'E2E Encrypted',
    'chat.startConversation': 'Start of conversation with {{name}}',
    'chat.allEncrypted': 'All messages are end-to-end encrypted.',
    'chat.messageTo': 'Message to {{name}}...',
    'chat.user': 'user',
    'voice.muted': 'Muted',
    'voice.connected': 'Connected to voice',
    'voice.waiting': 'Waiting for participants...',
    'voice.me': '(you)',
    'voice.sharingYourScreen': 'Sharing your screen',
    'voice.remoteScreen': '{{name}}\'s screen',
    'voice.unmute': 'Unmute',
    'voice.mute': 'Mute',
    'voice.stopShare': 'Stop sharing',
    'voice.share': 'Share screen',
    'voice.leave': 'Leave voice channel',
    'screen.title': 'Share screen',
    'screen.select': 'Select the screen or window to share',
    'screen.loading': 'Loading available screens...',
    'screen.none': 'No screen or window found.',
    'screen.cancel': 'Cancel',
  },
  es: {},
  ar: {},
  ru: {},
}

translations.es = { ...translations.en,
  'title.updateReady': 'Actualización lista',
  'title.updateAvailable': 'Actualización disponible',
  'title.downloadNow': 'Descargar ahora',
  'login.signIn': 'Entrar',
  'login.createAccount': 'Crear cuenta',
  'nav.home': 'Inicio',
  'friends.title': 'Amigos',
  'groups.title': 'Grupos',
  'servers.title': 'Servidores',
  'screen.cancel': 'Cancelar',
}

translations.ar = { ...translations.en,
  'title.updateReady': 'التحديث جاهز',
  'title.updateAvailable': 'يوجد تحديث',
  'title.downloadNow': 'تنزيل الآن',
  'login.signIn': 'تسجيل الدخول',
  'login.createAccount': 'إنشاء حساب',
  'nav.home': 'الرئيسية',
  'friends.title': 'الأصدقاء',
  'groups.title': 'المجموعات',
  'servers.title': 'الخوادم',
  'screen.cancel': 'إلغاء',
}

translations.ru = { ...translations.en,
  'title.updateReady': 'Обновление готово',
  'title.updateAvailable': 'Доступно обновление',
  'title.downloadNow': 'Скачать сейчас',
  'login.signIn': 'Войти',
  'login.createAccount': 'Создать аккаунт',
  'nav.home': 'Главная',
  'friends.title': 'Друзья',
  'groups.title': 'Группы',
  'servers.title': 'Серверы',
  'screen.cancel': 'Отмена',
}

type LanguageState = {
  language: Language
  setLanguage: (language: Language) => void
}

const useLanguageStore = create<LanguageState>((set) => ({
  language: getInitialLanguage(),
  setLanguage: (language) => {
    localStorage.setItem(STORAGE_KEY, language)
    set({ language })
  },
}))

function format(template: string, params?: Params): string {
  if (!params) return template
  return Object.entries(params).reduce((result, [key, value]) => {
    return result.split(`{{${key}}}`).join(String(value))
  }, template)
}

export function useI18n() {
  const language = useLanguageStore((s) => s.language)
  const setLanguage = useLanguageStore((s) => s.setLanguage)
  const rtl = language === 'ar'

  function t(key: string, params?: Params): string {
    const dictionary = translations[language] || translations['pt-BR']
    const fallback = translations['pt-BR'][key] || key
    return format(dictionary[key] || fallback, params)
  }

  return { language, setLanguage, t, rtl }
}

export const languageOptions: Array<{ code: Language; label: string }> = [
  { code: 'pt-BR', label: 'Português (Brasil)' },
  { code: 'en', label: 'English' },
  { code: 'es', label: 'Español' },
  { code: 'ar', label: 'العربية' },
  { code: 'ru', label: 'Русский' },
]
